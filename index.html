<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AN IRRASE EXPERIENCE - Treasure Hunt</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Mapbox -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #000000;
            --secondary: #ffffff;
            --accent: #0070f3;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: white;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        
        .primary-btn {
            background: linear-gradient(135deg, #ffffff, #f0f0f0);
            color: #000;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
        }
        
        .primary-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg, #ffffff, #e0e0e0);
        }
        
        .primary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .secondary-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .secondary-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .danger-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .timer {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px 16px;
            font-variant-numeric: tabular-nums;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .notification-dot {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .active-nav {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .hidden {
            display: none !important;
        }
        
        .mapboxgl-canvas {
            border-radius: 12px;
        }
        
        @media (max-width: 768px) {
            .glass-card {
                border-radius: 12px;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Auth Screen -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md space-y-8 fade-in">
            <div class="text-center">
                <h1 class="text-4xl font-black mb-3 bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">
                    AN IRRASE EXPERIENCE
                </h1>
                <p class="text-gray-400">Treasure Hunt Adventure</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="glass-card p-8">
                <div id="authError" class="hidden bg-red-500/20 border border-red-500/30 text-red-300 p-4 rounded-xl mb-6 text-sm"></div>
                
                <h2 class="text-xl font-bold mb-6">Sign In to Play</h2>
                <form id="loginFormElement">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Email Address</label>
                            <input 
                                type="email" 
                                id="loginEmail" 
                                required 
                                class="w-full h-12 rounded-xl bg-white/5 border border-white/10 px-4 focus:outline-none focus:border-white/30 transition-all duration-200 text-white placeholder-gray-500"
                                placeholder="player@example.com"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                            <input 
                                type="password" 
                                id="loginPassword" 
                                required 
                                class="w-full h-12 rounded-xl bg-white/5 border border-white/10 px-4 focus:outline-none focus:border-white/30 transition-all duration-200 text-white placeholder-gray-500"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            >
                        </div>
                        
                        <button type="button" onclick="handleLogin()" id="loginBtn" class="w-full h-12 rounded-xl primary-btn font-semibold text-base">
                            <span id="loginBtnText">Sign In to Play</span>
                            <span id="loginBtnSpinner" class="hidden ml-2"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                </form>
                
                <div class="mt-6 pt-6 border-t border-white/10 text-center">
                    <p class="text-sm text-gray-400">
                        New to the hunt? 
                        <button type="button" onclick="toggleAuthMode()" class="text-white font-medium hover:underline">
                            Create Account
                        </button>
                    </p>
                </div>
            </div>
            
            <!-- Signup Form -->
            <div id="signupForm" class="glass-card p-8 hidden">
                <div id="signupError" class="hidden bg-red-500/20 border border-red-500/30 text-red-300 p-4 rounded-xl mb-6 text-sm"></div>
                
                <h2 class="text-xl font-bold mb-6">Join the Adventure</h2>
                <form id="signupFormElement">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Full Name</label>
                            <input 
                                type="text" 
                                id="signupName" 
                                required 
                                class="w-full h-12 rounded-xl bg-white/5 border border-white/10 px-4 focus:outline-none focus:border-white/30 transition-all duration-200 text-white placeholder-gray-500"
                                placeholder="John Doe"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Email Address</label>
                            <input 
                                type="email" 
                                id="signupEmail" 
                                required 
                                class="w-full h-12 rounded-xl bg-white/5 border border-white/10 px-4 focus:outline-none focus:border-white/30 transition-all duration-200 text-white placeholder-gray-500"
                                placeholder="player@example.com"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Password (min. 6 characters)</label>
                            <input 
                                type="password" 
                                id="signupPassword" 
                                required 
                                minlength="6"
                                class="w-full h-12 rounded-xl bg-white/5 border border-white/10 px-4 focus:outline-none focus:border-white/30 transition-all duration-200 text-white placeholder-gray-500"
                                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Team Name (Optional)</label>
                            <input 
                                type="text" 
                                id="signupTeam" 
                                class="w-full h-12 rounded-xl bg-white/5 border border-white/10 px-4 focus:outline-none focus:border-white/30 transition-all duration-200 text-white placeholder-gray-500"
                                placeholder="The Adventurers"
                            >
                        </div>
                        
                        <button type="button" onclick="handleSignup()" id="signupBtn" class="w-full h-12 rounded-xl primary-btn font-semibold text-base">
                            <span id="signupBtnText">Create Account & Start</span>
                            <span id="signupBtnSpinner" class="hidden ml-2"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                    </div>
                </form>
                
                <div class="mt-6 pt-6 border-t border-white/10 text-center">
                    <p class="text-sm text-gray-400">
                        Already have an account? 
                        <button type="button" onclick="toggleAuthMode()" class="text-white font-medium hover:underline">
                            Sign In
                        </button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Top Header -->
        <header class="fixed top-0 left-0 right-0 h-16 bg-black/80 backdrop-blur-xl border-b border-white/10 z-50">
            <div class="h-full px-4 flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center gap-4">
                    <button type="button" onclick="toggleSidebar()" class="lg:hidden w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <h1 class="text-lg font-bold hidden md:block">AN IRRASE EXPERIENCE</h1>
                    
                    <div class="timer flex items-center gap-2">
                        <i class="fas fa-clock text-gray-400"></i>
                        <span id="eventTimer" class="font-bold">08:00:00</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="glass-card px-4 py-2 rounded-xl flex items-center gap-2">
                        <i class="fas fa-coins text-yellow-400"></i>
                        <span id="coinDisplay" class="font-bold">0</span>
                    </div>
                    
                    <button type="button" onclick="showNotifications()" class="relative w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors">
                        <i class="fas fa-bell"></i>
                        <div id="notificationDot" class="notification-dot hidden"></div>
                    </button>
                    
                    <button type="button" onclick="showProfile()" class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors">
                        <i class="fas fa-user"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Desktop Sidebar -->
        <nav id="sidebar" class="hidden lg:block fixed left-0 top-16 bottom-0 w-64 bg-black/80 backdrop-blur-xl border-r border-white/10 z-40">
            <div class="p-4 space-y-2">
                <button type="button" onclick="showHome()" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-white/10 transition-colors active-nav" data-page="home">
                    <i class="fas fa-home w-5"></i>
                    <span>Home</span>
                </button>
                
                <button type="button" onclick="showMissions()" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-white/10 transition-colors" data-page="missions">
                    <i class="fas fa-tasks w-5"></i>
                    <span>Missions</span>
                    <span id="missionBadge" class="ml-auto badge badge-info hidden">0</span>
                </button>
                
                <button type="button" onclick="showLeaderboard()" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-white/10 transition-colors" data-page="leaderboard">
                    <i class="fas fa-trophy w-5"></i>
                    <span>Leaderboard</span>
                </button>
                
                <button type="button" onclick="showShop()" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-white/10 transition-colors" data-page="shop">
                    <i class="fas fa-gift w-5"></i>
                    <span>Rewards Shop</span>
                </button>
                
                <button type="button" onclick="showActivities()" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 hover:bg-white/10 transition-colors" data-page="activities">
                    <i class="fas fa-history w-5"></i>
                    <span>My Activities</span>
                </button>
            </div>
            
            <div class="absolute bottom-4 left-4 right-4">
                <button type="button" onclick="triggerSOS()" class="danger-btn w-full h-12 font-bold text-base">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    EMERGENCY SOS
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="pt-16 pb-20 lg:pb-4 lg:pl-64 min-h-screen">
            <!-- Home Page -->
            <div id="homePage" class="p-4 space-y-4 max-w-7xl mx-auto">
                <button type="button" onclick="triggerSOS()" class="danger-btn w-full h-16 text-lg lg:hidden">
                    <i class="fas fa-exclamation-triangle mr-3"></i>
                    EMERGENCY SOS
                </button>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-card p-4">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center">
                                <i class="fas fa-tasks text-blue-400"></i>
                            </div>
                        </div>
                        <div class="text-2xl font-bold" id="missionCount">0</div>
                        <div class="text-sm text-gray-400">Active Missions</div>
                    </div>
                    
                    <div class="glass-card p-4">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-xl bg-green-500/20 flex items-center justify-center">
                                <i class="fas fa-map-marker-alt text-green-400"></i>
                            </div>
                        </div>
                        <div class="text-2xl font-bold" id="zoneCount">0</div>
                        <div class="text-sm text-gray-400">Game Zones</div>
                    </div>
                </div>
                
                <div class="glass-card overflow-hidden">
                    <div class="p-4 border-b border-white/10">
                        <h2 class="text-lg font-bold">Treasure Hunt Map</h2>
                        <p class="text-sm text-gray-400">Your current location and mission zones</p>
                    </div>
                    <div id="map" class="w-full h-[300px] bg-gradient-to-br from-blue-900/20 to-purple-900/20">
                        <!-- Map will be loaded here -->
                    </div>
                </div>
                
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold">Your Missions</h3>
                        <button type="button" onclick="showMissions()" class="text-sm text-gray-400 hover:text-white flex items-center">
                            View All
                            <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                    <div id="activeMissionsList" class="space-y-3">
                        <div class="glass-card p-6 text-center">
                            <i class="fas fa-flag text-3xl text-gray-400 mb-3"></i>
                            <p class="text-gray-400">No missions yet</p>
                            <p class="text-sm text-gray-500 mt-1">Complete tutorials to unlock missions</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Missions Page -->
            <div id="missionsPage" class="hidden p-4 space-y-4 max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <button type="button" onclick="showHome()" class="secondary-btn px-4 py-2 flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back
                    </button>
                    <h2 class="text-xl font-bold">All Missions</h2>
                    <div class="w-20"></div>
                </div>
                
                <div id="missionsList" class="space-y-4">
                    <!-- Missions will be loaded from database -->
                </div>
            </div>

            <!-- Leaderboard Page -->
            <div id="leaderboardPage" class="hidden p-4 space-y-4 max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <button type="button" onclick="showHome()" class="secondary-btn px-4 py-2 flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back
                    </button>
                    <h2 class="text-xl font-bold">Leaderboard</h2>
                    <div class="w-20"></div>
                </div>
                
                <div class="glass-card p-4">
                    <div id="leaderboardList" class="space-y-3">
                        <!-- Leaderboard will be loaded from database -->
                    </div>
                </div>
            </div>

            <!-- Shop Page -->
            <div id="shopPage" class="hidden p-4 space-y-4 max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <button type="button" onclick="showHome()" class="secondary-btn px-4 py-2 flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back
                    </button>
                    <h2 class="text-xl font-bold">Rewards Shop</h2>
                    <div class="w-20"></div>
                </div>
                
                <div id="shopItems" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Shop items will be loaded from database -->
                </div>
            </div>

            <!-- Activities Page -->
            <div id="activitiesPage" class="hidden p-4 space-y-4 max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <button type="button" onclick="showHome()" class="secondary-btn px-4 py-2 flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back
                    </button>
                    <h2 class="text-xl font-bold">My Activities</h2>
                    <div class="w-20"></div>
                </div>
                
                <div id="activitiesList" class="space-y-3">
                    <!-- Activities will be loaded from database -->
                </div>
            </div>

            <!-- Notifications Page -->
            <div id="notificationsPage" class="hidden p-4 space-y-4 max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <button type="button" onclick="showHome()" class="secondary-btn px-4 py-2 flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back
                    </button>
                    <h2 class="text-xl font-bold">Notifications</h2>
                    <button type="button" onclick="markAllAsRead()" class="text-sm text-gray-400 hover:text-white">
                        Mark all read
                    </button>
                </div>
                
                <div id="notificationsList" class="space-y-3">
                    <!-- Notifications will be loaded from database -->
                </div>
            </div>
        </main>

        <!-- Mobile Bottom Navigation -->
        <nav class="lg:hidden fixed bottom-0 left-0 right-0 h-20 bg-black/90 backdrop-blur-xl border-t border-white/10 z-50">
            <div class="h-full flex items-center justify-around px-4">
                <button type="button" onclick="showHome()" class="flex flex-col items-center gap-1 text-blue-400" data-page="home">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-xs">Home</span>
                </button>
                
                <button type="button" onclick="showMissions()" class="flex flex-col items-center gap-1 text-gray-400" data-page="missions">
                    <i class="fas fa-tasks text-xl"></i>
                    <span class="text-xs">Missions</span>
                </button>
                
                <button type="button" onclick="showLeaderboard()" class="flex flex-col items-center gap-1 text-gray-400" data-page="leaderboard">
                    <i class="fas fa-trophy text-xl"></i>
                    <span class="text-xs">Leaderboard</span>
                </button>
                
                <button type="button" onclick="showShop()" class="flex flex-col items-center gap-1 text-gray-400" data-page="shop">
                    <i class="fas fa-gift text-xl"></i>
                    <span class="text-xs">Shop</span>
                </button>
                
                <button type="button" onclick="showNotifications()" class="relative flex flex-col items-center gap-1 text-gray-400" data-page="notifications">
                    <i class="fas fa-bell text-xl"></i>
                    <span class="text-xs">Alerts</span>
                    <div id="mobileNotificationDot" class="notification-dot hidden"></div>
                </button>
            </div>
        </nav>
    </div>

    <!-- Mission Modal -->
    <div id="missionModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="glass-card max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold" id="modalMissionTitle">Mission Details</h3>
                        <button type="button" onclick="closeMissionModal()" class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div id="modalMissionContent" class="space-y-4"></div>
                    
                    <div class="mt-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                <i class="fas fa-camera mr-2"></i>
                                Upload Photo/Video
                            </label>
                            <input 
                                type="file" 
                                id="mediaInput" 
                                accept="image/*,video/*"
                                class="w-full h-12 rounded-xl bg-white/5 border border-white/10 px-4 focus:outline-none focus:border-white/30 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-white file:text-black"
                            >
                            <div id="mediaPreview" class="mt-3"></div>
                        </div>
                        
                        <button type="button" onclick="submitMission()" id="submitMissionBtn" class="w-full h-12 rounded-xl primary-btn font-semibold">
                            <i class="fas fa-paper-plane mr-2"></i>
                            Submit Mission
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="glass-card max-w-md w-full">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold">Your Profile</h3>
                        <button type="button" onclick="closeProfile()" class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center hover:bg-white/20 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="text-center">
                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center text-4xl mx-auto mb-4">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <h4 class="text-xl font-bold" id="profileName">Loading...</h4>
                            <p class="text-gray-400" id="profileEmail">Loading...</p>
                            <p class="text-sm text-gray-400 mt-1" id="profileTeam">Team: Loading...</p>
                        </div>
                        
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-300">Total Coins</span>
                                <span class="text-xl font-bold flex items-center gap-2">
                                    <i class="fas fa-coins text-yellow-400"></i>
                                    <span id="profileCoins">0</span>
                                </span>
                            </div>
                        </div>
                        
                        <button type="button" onclick="handleLogout()" class="w-full h-12 rounded-xl secondary-btn font-medium">
                            <i class="fas fa-sign-out-alt mr-2"></i>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-24 right-4 z-50 space-y-2 max-w-md"></div>

    <script>
        // ============================
        // CONFIGURATION
        // ============================
        
        // Supabase Configuration
        const SUPABASE_URL = 'https://wllpidtujqnfohpsfqyy.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_9lIP3MDWOz2_Udkrhx4tjw_cpFkyuRa';
        
        // Mapbox Configuration
        mapboxgl.accessToken = 'pk.eyJ1IjoianVzYSIsImEiOiJjbTZnc2Y0a2swNHFuMmxwbzBxYm80aTh3In0.RHyfezw9C01ZXlgOiymD0Q';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ============================
        // APP STATE
        // ============================
        let currentUser = null;
        let userProfile = null;
        let map = null;
        let currentPage = 'home';
        let eventTimerInterval = null;
        let currentMission = null;
        let missions = [];
        let userMissions = [];
        let zones = [];
        let prizes = [];
        let submissions = [];
        let notifications = [];
        let leaderboard = [];

        // ============================
        // INITIALIZATION
        // ============================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('App initialized');
            checkExistingSession();
            
            // Prevent form submission
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', (e) => e.preventDefault());
            });
        });

        async function checkExistingSession() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                await loadUserProfile();
                showMainApp();
            }
        }

        // ============================
        // AUTH FUNCTIONS
        // ============================
        function toggleAuthMode() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            loginForm.classList.toggle('hidden');
            signupForm.classList.toggle('hidden');
            
            // Clear errors
            document.getElementById('authError').classList.add('hidden');
            document.getElementById('signupError').classList.add('hidden');
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('authError', 'Please fill in all fields');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loginBtnSpinner = document.getElementById('loginBtnSpinner');
            
            loginBtn.disabled = true;
            loginBtnText.textContent = 'Signing in...';
            loginBtnSpinner.classList.remove('hidden');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                await loadUserProfile();
                showMainApp();
                showToast('Welcome to the Treasure Hunt! ðŸŽ¯', 'success');
                
            } catch (error) {
                showError('authError', error.message || 'Invalid credentials');
            } finally {
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Sign In to Play';
                loginBtnSpinner.classList.add('hidden');
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const team = document.getElementById('signupTeam').value;
            
            if (!name || !email || !password) {
                showError('signupError', 'Please fill in all required fields');
                return;
            }
            
            if (password.length < 6) {
                showError('signupError', 'Password must be at least 6 characters');
                return;
            }
            
            const signupBtn = document.getElementById('signupBtn');
            const signupBtnText = document.getElementById('signupBtnText');
            const signupBtnSpinner = document.getElementById('signupBtnSpinner');
            
            signupBtn.disabled = true;
            signupBtnText.textContent = 'Creating account...';
            signupBtnSpinner.classList.remove('hidden');
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            name: name,
                            team_name: team || null
                        }
                    }
                });
                
                if (error) throw error;
                
                // The user will be created in the database via the trigger
                // We need to wait a moment for the trigger to execute
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Now sign in the user
                const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (signInError) {
                    showError('signupError', 'Account created. Please sign in.');
                    toggleAuthMode();
                    return;
                }
                
                currentUser = signInData.user;
                await loadUserProfile();
                showMainApp();
                showToast('Welcome to the Treasure Hunt! Your adventure begins now. ðŸŽ‰', 'success');
                
            } catch (error) {
                showError('signupError', error.message || 'Error creating account');
            } finally {
                signupBtn.disabled = false;
                signupBtnText.textContent = 'Create Account & Start';
                signupBtnSpinner.classList.add('hidden');
            }
        }

        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // ============================
        // USER PROFILE & DATA
        // ============================
        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                // First, check if user exists in our database
                const { data: existingUser, error: fetchError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('auth_uid', currentUser.id)
                    .single();
                
                if (fetchError || !existingUser) {
                    // Create user profile if it doesn't exist
                    const { data: newUser, error: createError } = await supabase
                        .from('users')
                        .insert({
                            auth_uid: currentUser.id,
                            email: currentUser.email,
                            name: currentUser.user_metadata?.name || currentUser.email.split('@')[0],
                            team_name: currentUser.user_metadata?.team_name || null,
                            coins: 100, // Starting coins
                            is_admin: false
                        })
                        .select()
                        .single();
                    
                    if (createError) throw createError;
                    userProfile = newUser;
                    
                    // Create welcome notification for new user
                    await createWelcomeNotification();
                    
                } else {
                    userProfile = existingUser;
                }
                
                // Load all app data
                await loadAppData();
                
                // Update UI
                updateUI();
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showToast('Error loading profile data', 'error');
            }
        }

        async function createWelcomeNotification() {
            try {
                await supabase
                    .from('notifications')
                    .insert({
                        user_id: userProfile.id,
                        title: 'Welcome to the Hunt!',
                        message: 'Your adventure begins now. Complete missions to earn coins and climb the leaderboard.',
                        type: 'info'
                    });
                
                // Also create notification about available missions
                await supabase
                    .from('notifications')
                    .insert({
                        user_id: userProfile.id,
                        title: 'Missions Available',
                        message: 'Check the missions page to start your first treasure hunt challenge!',
                        type: 'info'
                    });
                
            } catch (error) {
                console.error('Error creating welcome notification:', error);
            }
        }

        async function loadAppData() {
            try {
                await Promise.all([
                    loadMissions(),
                    loadZones(),
                    loadPrizes(),
                    loadLeaderboard(),
                    loadNotifications(),
                    loadUserMissions(),
                    loadSubmissions()
                ]);
                
                // Initialize user missions for new missions
                await initializeUserMissions();
                
            } catch (error) {
                console.error('Error loading app data:', error);
            }
        }

        async function loadMissions() {
            try {
                const { data, error } = await supabase
                    .from('missions')
                    .select(`
                        *,
                        zones (name)
                    `)
                    .eq('active', true)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                missions = data || [];
                
            } catch (error) {
                console.error('Error loading missions:', error);
                missions = [];
            }
        }

        async function loadZones() {
            try {
                const { data, error } = await supabase
                    .from('zones')
                    .select('*')
                    .eq('active', true);
                
                if (error) throw error;
                zones = data || [];
                
            } catch (error) {
                console.error('Error loading zones:', error);
                zones = [];
            }
        }

        async function loadPrizes() {
            try {
                const { data, error } = await supabase
                    .from('prizes')
                    .select('*')
                    .eq('active', true)
                    .gt('remaining_quantity', 0)
                    .order('price', { ascending: true });
                
                if (error) throw error;
                prizes = data || [];
                
            } catch (error) {
                console.error('Error loading prizes:', error);
                prizes = [];
            }
        }

        async function loadLeaderboard() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('id, name, team_name, coins')
                    .order('coins', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                leaderboard = data || [];
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                leaderboard = [];
            }
        }

        async function loadNotifications() {
            try {
                const { data, error } = await supabase
                    .from('notifications')
                    .select('*')
                    .eq('user_id', userProfile.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                notifications = data || [];
                
                updateNotificationDot();
                
            } catch (error) {
                console.error('Error loading notifications:', error);
                notifications = [];
            }
        }

        async function loadUserMissions() {
            try {
                const { data, error } = await supabase
                    .from('user_missions')
                    .select(`
                        *,
                        missions (*, zones (name))
                    `)
                    .eq('user_id', userProfile.id);
                
                if (error) throw error;
                userMissions = data || [];
                
            } catch (error) {
                console.error('Error loading user missions:', error);
                userMissions = [];
            }
        }

        async function loadSubmissions() {
            try {
                const { data, error } = await supabase
                    .from('submissions')
                    .select(`
                        *,
                        missions (title)
                    `)
                    .eq('user_id', userProfile.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                submissions = data || [];
                
            } catch (error) {
                console.error('Error loading submissions:', error);
                submissions = [];
            }
        }

        async function initializeUserMissions() {
            try {
                // Get all active missions
                const { data: allMissions, error: missionsError } = await supabase
                    .from('missions')
                    .select('id')
                    .eq('active', true);
                
                if (missionsError) throw missionsError;
                
                // Get user's existing missions
                const { data: existingUserMissions, error: userMissionsError } = await supabase
                    .from('user_missions')
                    .select('mission_id')
                    .eq('user_id', userProfile.id);
                
                if (userMissionsError) throw userMissionsError;
                
                const existingMissionIds = existingUserMissions.map(um => um.mission_id);
                const newMissions = allMissions.filter(mission => !existingMissionIds.includes(mission.id));
                
                // Create user missions for new missions
                if (newMissions.length > 0) {
                    const userMissionEntries = newMissions.map(mission => ({
                        user_id: userProfile.id,
                        mission_id: mission.id,
                        status: 'unlocked'
                    }));
                    
                    const { error: insertError } = await supabase
                        .from('user_missions')
                        .insert(userMissionEntries);
                    
                    if (insertError) throw insertError;
                    
                    // Reload user missions
                    await loadUserMissions();
                    
                    // Create notification for new missions
                    if (newMissions.length > 0) {
                        await supabase
                            .from('notifications')
                            .insert({
                                user_id: userProfile.id,
                                title: 'New Missions Unlocked!',
                                message: `You have ${newMissions.length} new missions available. Start exploring!`,
                                type: 'info'
                            });
                        
                        // Reload notifications
                        await loadNotifications();
                    }
                }
                
            } catch (error) {
                console.error('Error initializing user missions:', error);
            }
        }

        // ============================
        // MAIN APP FUNCTIONS
        // ============================
        function showMainApp() {
            // Hide auth screen
            document.getElementById('authScreen').classList.add('hidden');
            
            // Show main app
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Start timer
            startEventTimer();
            
            // Initialize map
            initializeMap();
            
            // Show home page
            showHome();
        }

        function updateUI() {
            if (userProfile) {
                document.getElementById('coinDisplay').textContent = userProfile.coins;
                document.getElementById('profileName').textContent = userProfile.name;
                document.getElementById('profileEmail').textContent = userProfile.email;
                document.getElementById('profileTeam').textContent = userProfile.team_name ? `Team: ${userProfile.team_name}` : 'No team';
                document.getElementById('profileCoins').textContent = userProfile.coins;
            }
        }

        function startEventTimer() {
            if (eventTimerInterval) {
                clearInterval(eventTimerInterval);
            }
            
            // Set event to end in 8 hours from now
            const endTime = new Date();
            endTime.setHours(endTime.getHours() + 8);
            
            function updateTimer() {
                const now = new Date();
                const diff = endTime - now;
                
                if (diff <= 0) {
                    document.getElementById('eventTimer').textContent = '00:00:00';
                    clearInterval(eventTimerInterval);
                    return;
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('eventTimer').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            updateTimer();
            eventTimerInterval = setInterval(updateTimer, 1000);
        }

        function initializeMap() {
            try {
                // Default coordinates (Windhoek, Namibia)
                const defaultCoords = [17.0832, -22.5609];
                
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/dark-v11',
                    center: defaultCoords,
                    zoom: 12
                });
                
                map.addControl(new mapboxgl.NavigationControl());
                
                // Add user marker
                new mapboxgl.Marker({ color: '#3b82f6' })
                    .setLngLat(defaultCoords)
                    .setPopup(new mapboxgl.Popup().setHTML('<h3 class="font-bold">Your Location</h3>'))
                    .addTo(map);
                
                // Add zone markers
                zones.forEach(zone => {
                    try {
                        const coords = zone.coordinates?.coordinates || defaultCoords;
                        new mapboxgl.Marker({ color: '#10b981' })
                            .setLngLat(coords)
                            .setPopup(new mapboxgl.Popup().setHTML(`
                                <h3 class="font-bold">${zone.name}</h3>
                                <p class="text-sm">${zone.description || 'Mission Zone'}</p>
                            `))
                            .addTo(map);
                    } catch (e) {
                        console.error('Error adding zone marker:', e);
                    }
                });
                
            } catch (error) {
                console.error('Map initialization error:', error);
                document.getElementById('map').innerHTML = `
                    <div class="h-full flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-map-marked-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-400">Map unavailable</p>
                        </div>
                    </div>
                `;
            }
        }

        // ============================
        // NAVIGATION
        // ============================
        function showHome() {
            hideAllPages();
            document.getElementById('homePage').classList.remove('hidden');
            setActiveNav('home');
            updateDashboard();
        }

        function showMissions() {
            hideAllPages();
            document.getElementById('missionsPage').classList.remove('hidden');
            setActiveNav('missions');
            displayAllMissions();
        }

        function showLeaderboard() {
            hideAllPages();
            document.getElementById('leaderboardPage').classList.remove('hidden');
            setActiveNav('leaderboard');
            displayLeaderboard();
        }

        function showShop() {
            hideAllPages();
            document.getElementById('shopPage').classList.remove('hidden');
            setActiveNav('shop');
            displayShopItems();
        }

        function showActivities() {
            hideAllPages();
            document.getElementById('activitiesPage').classList.remove('hidden');
            setActiveNav('activities');
            displayActivities();
        }

        function showNotifications() {
            hideAllPages();
            document.getElementById('notificationsPage').classList.remove('hidden');
            setActiveNav('notifications');
            displayNotifications();
        }

        function showProfile() {
            document.getElementById('profileModal').classList.remove('hidden');
        }

        function closeProfile() {
            document.getElementById('profileModal').classList.add('hidden');
        }

        function hideAllPages() {
            const pages = ['homePage', 'missionsPage', 'leaderboardPage', 'shopPage', 'activitiesPage', 'notificationsPage'];
            pages.forEach(page => {
                const element = document.getElementById(page);
                if (element) {
                    element.classList.add('hidden');
                }
            });
        }

        function setActiveNav(page) {
            // Desktop nav
            document.querySelectorAll('[data-page]').forEach(item => {
                if (item.dataset.page === page) {
                    item.classList.add('active-nav');
                } else {
                    item.classList.remove('active-nav');
                }
            });
            
            // Mobile nav
            const mobileBtns = document.querySelectorAll('nav.lg\\:hidden button');
            mobileBtns.forEach(btn => {
                if (btn.getAttribute('data-page') === page) {
                    btn.classList.add('text-blue-400');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('text-blue-400');
                    btn.classList.add('text-gray-400');
                }
            });
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('hidden');
        }

        // ============================
        // DASHBOARD UPDATES
        // ============================
        function updateDashboard() {
            // Update mission count
            const activeMissionCount = userMissions.filter(um => 
                um.status === 'unlocked' || um.status === 'pending'
            ).length;
            
            document.getElementById('missionCount').textContent = activeMissionCount;
            
            const missionBadge = document.getElementById('missionBadge');
            if (activeMissionCount > 0) {
                missionBadge.textContent = activeMissionCount;
                missionBadge.classList.remove('hidden');
            } else {
                missionBadge.classList.add('hidden');
            }
            
            // Update zone count
            document.getElementById('zoneCount').textContent = zones.length;
            
            // Display active missions
            displayActiveMissions();
        }

        function displayActiveMissions() {
            const list = document.getElementById('activeMissionsList');
            if (!list) return;
            
            const activeMissions = userMissions
                .filter(um => um.status === 'unlocked' || um.status === 'pending')
                .slice(0, 3);
            
            if (activeMissions.length === 0) {
                list.innerHTML = `
                    <div class="glass-card p-6 text-center">
                        <i class="fas fa-flag text-3xl text-gray-400 mb-3"></i>
                        <p class="text-gray-400">No active missions yet</p>
                        <button onclick="showMissions()" class="secondary-btn px-4 py-2 mt-3 text-sm">
                            Explore Missions
                        </button>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = activeMissions.map(userMission => {
                const mission = userMission.missions;
                const statusClass = userMission.status === 'completed' ? 'badge-success' : 
                                 userMission.status === 'pending' ? 'badge-warning' : 'badge-info';
                
                return `
                    <div class="glass-card p-4 cursor-pointer hover:bg-white/5 transition-colors" 
                         onclick="openMissionModal('${mission.id}')">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-semibold">${mission.title}</h4>
                                    <span class="badge ${statusClass}">
                                        ${userMission.status}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-300 line-clamp-2">${mission.description}</p>
                                <div class="flex items-center gap-2 mt-3">
                                    <span class="text-xs bg-white/10 px-2 py-1 rounded-full">
                                        <i class="fas fa-coins mr-1 text-yellow-400"></i>${mission.points}
                                    </span>
                                    ${mission.zones ? 
                                        `<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">
                                            ${mission.zones.name}
                                        </span>` : ''}
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 mt-1"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================
        // MISSIONS DISPLAY
        // ============================
        function displayAllMissions() {
            const list = document.getElementById('missionsList');
            if (!list) return;
            
            if (userMissions.length === 0) {
                list.innerHTML = `
                    <div class="glass-card p-8 text-center">
                        <i class="fas fa-flag text-4xl text-gray-400 mb-4"></i>
                        <h3 class="font-bold mb-2">No Missions Available</h3>
                        <p class="text-gray-400">Check back later for new missions!</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = userMissions.map(userMission => {
                const mission = userMission.missions;
                const statusClass = userMission.status === 'completed' ? 'badge-success' : 
                                 userMission.status === 'pending' ? 'badge-warning' : 'badge-info';
                
                return `
                    <div class="glass-card p-4 cursor-pointer hover:bg-white/5 transition-colors" 
                         onclick="openMissionModal('${mission.id}')">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <h4 class="font-semibold">${mission.title}</h4>
                                    <span class="badge ${statusClass}">
                                        ${userMission.status}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-300">${mission.description}</p>
                                <div class="flex items-center gap-2 mt-3">
                                    <span class="text-xs bg-white/10 px-2 py-1 rounded-full">
                                        <i class="fas fa-coins mr-1 text-yellow-400"></i>${mission.points}
                                    </span>
                                    ${mission.zones ? 
                                        `<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full">
                                            ${mission.zones.name}
                                        </span>` : ''}
                                    <span class="text-xs bg-purple-500/20 text-purple-400 px-2 py-1 rounded-full">
                                        ${mission.mission_type}
                                    </span>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 mt-1"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function openMissionModal(missionId) {
            try {
                // Find the user mission
                const userMission = userMissions.find(um => um.mission_id === missionId);
                if (!userMission) return;
                
                const mission = userMission.missions;
                currentMission = mission;
                
                document.getElementById('modalMissionTitle').textContent = mission.title;
                document.getElementById('modalMissionContent').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-2">Description</h4>
                            <p class="text-gray-300">${mission.description}</p>
                        </div>
                        
                        ${mission.instructions ? `
                            <div class="glass-card rounded-xl p-4">
                                <h4 class="font-semibold mb-2">Instructions</h4>
                                <p class="text-gray-300">${mission.instructions}</p>
                            </div>
                        ` : ''}
                        
                        <div class="glass-card rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-gray-300">Mission Reward:</span>
                                <span class="font-bold text-lg flex items-center gap-2">
                                    <i class="fas fa-coins text-yellow-400"></i>
                                    ${mission.points}
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-300">Status:</span>
                                <span class="font-medium ${userMission.status === 'completed' ? 'text-green-400' : userMission.status === 'pending' ? 'text-yellow-400' : 'text-blue-400'}">
                                    ${userMission.status === 'completed' ? 'Completed âœ“' : userMission.status === 'pending' ? 'Pending Review â³' : 'Ready to Submit'}
                                </span>
                            </div>
                            ${mission.zones ? `
                                <div class="flex items-center justify-between mt-3">
                                    <span class="text-gray-300">Zone:</span>
                                    <span class="font-medium">${mission.zones.name}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                const submitBtn = document.getElementById('submitMissionBtn');
                if (userMission.status === 'completed' || userMission.status === 'pending') {
                    submitBtn.disabled = true;
                    submitBtn.classList.remove('primary-btn');
                    submitBtn.classList.add('secondary-btn');
                    submitBtn.innerHTML = userMission.status === 'completed' 
                        ? '<i class="fas fa-check mr-2"></i>Mission Completed'
                        : '<i class="fas fa-clock mr-2"></i>Pending Review';
                } else {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('secondary-btn');
                    submitBtn.classList.add('primary-btn');
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit Mission';
                }
                
                document.getElementById('missionModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading mission:', error);
                showToast('Error loading mission details', 'error');
            }
        }

        function closeMissionModal() {
            document.getElementById('missionModal').classList.add('hidden');
            document.getElementById('mediaInput').value = '';
            document.getElementById('mediaPreview').innerHTML = '';
            currentMission = null;
        }

        async function submitMission() {
            if (!currentMission || !userProfile) return;
            
            const mediaInput = document.getElementById('mediaInput');
            if (!mediaInput.files[0]) {
                showToast('Please upload a photo or video', 'warning');
                return;
            }
            
            try {
                // In a real implementation, you would upload to Supabase Storage
                // For now, we'll create a submission record
                
                const { data, error } = await supabase
                    .from('submissions')
                    .insert({
                        user_id: userProfile.id,
                        mission_id: currentMission.id,
                        gps_location: JSON.stringify({ lat: -22.5609, lng: 17.0832 }), // Default Windhoek location
                        status: 'pending'
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Update user mission status
                const { error: updateError } = await supabase
                    .from('user_missions')
                    .update({ status: 'pending' })
                    .eq('user_id', userProfile.id)
                    .eq('mission_id', currentMission.id);
                
                if (updateError) throw updateError;
                
                // Reload data
                await loadUserMissions();
                await loadSubmissions();
                await loadNotifications();
                
                // Create notification
                await supabase
                    .from('notifications')
                    .insert({
                        user_id: userProfile.id,
                        title: 'Mission Submitted',
                        message: `Your submission for "${currentMission.title}" is pending review.`,
                        type: 'info'
                    });
                
                showToast('Mission submitted! Awaiting verification. ðŸŽ¯', 'success');
                closeMissionModal();
                
            } catch (error) {
                console.error('Error submitting mission:', error);
                showToast('Error submitting mission: ' + error.message, 'error');
            }
        }

        // ============================
        // LEADERBOARD DISPLAY
        // ============================
        function displayLeaderboard() {
            const list = document.getElementById('leaderboardList');
            if (!list) return;
            
            if (leaderboard.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-trophy text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-400">No leaderboard data yet</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = leaderboard.map((user, index) => {
                const rank = index + 1;
                const isCurrentUser = user.id === userProfile?.id;
                const rankColor = rank === 1 ? 'text-yellow-400' : rank === 2 ? 'text-gray-300' : rank === 3 ? 'text-amber-600' : 'text-gray-400';
                const rankIcon = rank === 1 ? 'ðŸ‘‘' : rank === 2 ? 'ðŸ¥ˆ' : rank === 3 ? 'ðŸ¥‰' : rank;
                
                return `
                    <div class="flex items-center gap-4 p-3 rounded-xl ${isCurrentUser ? 'bg-white/10' : ''}">
                        <div class="w-10 h-10 rounded-xl ${rankColor} flex items-center justify-center font-bold text-lg">
                            ${rankIcon}
                        </div>
                        
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="font-semibold ${isCurrentUser ? 'text-blue-400' : ''}">
                                    ${user.name}
                                </span>
                                ${isCurrentUser ? '<span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded-full">You</span>' : ''}
                            </div>
                            <div class="text-sm text-gray-400">${user.team_name || 'No team'}</div>
                        </div>
                        
                        <div class="text-right">
                            <div class="font-bold flex items-center gap-1">
                                <i class="fas fa-coins text-yellow-400"></i>
                                ${user.coins}
                            </div>
                            <div class="text-xs text-gray-400">coins</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================
        // SHOP DISPLAY
        // ============================
        function displayShopItems() {
            const container = document.getElementById('shopItems');
            if (!container) return;
            
            if (prizes.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-12">
                        <i class="fas fa-gift text-4xl text-gray-400 mb-3"></i>
                        <h3 class="font-bold mb-2">No Rewards Available</h3>
                        <p class="text-gray-400">Check back later for new rewards!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = prizes.map(item => {
                const canAfford = userProfile && userProfile.coins >= item.price;
                const isOutOfStock = item.remaining_quantity <= 0;
                
                return `
                    <div class="glass-card p-4">
                        <div class="aspect-square rounded-xl bg-gradient-to-br from-blue-900/20 to-purple-900/20 flex items-center justify-center text-6xl mb-4">
                            <i class="fas fa-gift text-gray-400"></i>
                        </div>
                        
                        <h4 class="font-semibold mb-1">${item.name}</h4>
                        <p class="text-sm text-gray-300 line-clamp-2 mb-3">${item.description || 'No description'}</p>
                        
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-1">
                                <i class="fas fa-coins text-yellow-400"></i>
                                <span class="font-bold">${item.price}</span>
                            </div>
                            <div class="text-xs ${item.remaining_quantity <= 3 ? 'text-orange-400' : 'text-gray-400'}">
                                ${item.remaining_quantity} left
                            </div>
                        </div>
                        
                        <button type="button" onclick="buyItem('${item.id}')" 
                                ${!canAfford || isOutOfStock ? 'disabled' : ''}
                                class="w-full h-10 rounded-xl ${!canAfford || isOutOfStock ? 'secondary-btn opacity-50 cursor-not-allowed' : 'primary-btn'}">
                            ${isOutOfStock ? 'Out of Stock' : !canAfford ? `Need ${item.price - userProfile.coins} more` : 'Buy Now'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function buyItem(itemId) {
            const item = prizes.find(i => i.id === itemId);
            if (!item || !userProfile || userProfile.coins < item.price) {
                showToast('Insufficient coins', 'warning');
                return;
            }
            
            if (item.remaining_quantity <= 0) {
                showToast('Item is out of stock', 'warning');
                return;
            }
            
            const confirmed = confirm(`Buy ${item.name} for ${item.price} coins?`);
            if (!confirmed) return;
            
            try {
                // Create purchase record
                const { data: purchase, error: purchaseError } = await supabase
                    .from('purchases')
                    .insert({
                        user_id: userProfile.id,
                        prize_id: item.id,
                        quantity: 1,
                        total_price: item.price,
                        status: 'completed'
                    })
                    .select()
                    .single();
                
                if (purchaseError) throw purchaseError;
                
                // Update prize quantity
                const { error: updateError } = await supabase
                    .from('prizes')
                    .update({ 
                        remaining_quantity: item.remaining_quantity - 1 
                    })
                    .eq('id', item.id);
                
                if (updateError) throw updateError;
                
                // Update user coins
                const { error: userError } = await supabase
                    .from('users')
                    .update({ 
                        coins: userProfile.coins - item.price 
                    })
                    .eq('id', userProfile.id);
                
                if (userError) throw userError;
                
                // Update local state
                userProfile.coins -= item.price;
                item.remaining_quantity--;
                
                // Update UI
                updateUI();
                displayShopItems();
                
                // Create notification
                await supabase
                    .from('notifications')
                    .insert({
                        user_id: userProfile.id,
                        title: 'Purchase Successful',
                        message: `You bought ${item.name} for ${item.price} coins`,
                        type: 'success'
                    });
                
                showToast(`Purchased ${item.name}! ðŸŽ`, 'success');
                
            } catch (error) {
                console.error('Error purchasing item:', error);
                showToast('Error purchasing item: ' + error.message, 'error');
            }
        }

        // ============================
        // ACTIVITIES DISPLAY
        // ============================
        function displayActivities() {
            const list = document.getElementById('activitiesList');
            if (!list) return;
            
            if (submissions.length === 0) {
                list.innerHTML = `
                    <div class="glass-card p-8 text-center">
                        <i class="fas fa-history text-4xl text-gray-400 mb-4"></i>
                        <h3 class="font-bold mb-2">No Activities Yet</h3>
                        <p class="text-gray-400">Complete missions to see your activities here!</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = submissions.map(submission => {
                const statusColor = submission.status === 'approved' ? 'text-green-400' : 
                                  submission.status === 'rejected' ? 'text-red-400' : 'text-yellow-400';
                const missionTitle = submission.missions?.title || 'Unknown Mission';
                
                return `
                    <div class="glass-card p-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h4 class="font-semibold">${missionTitle}</h4>
                                <p class="text-sm text-gray-400 mt-1">
                                    Submitted ${formatTimeAgo(submission.created_at)}
                                </p>
                                ${submission.admin_notes ? `
                                    <div class="mt-2 p-2 bg-white/5 rounded-lg">
                                        <p class="text-sm text-gray-300">${submission.admin_notes}</p>
                                    </div>
                                ` : ''}
                            </div>
                            <span class="text-sm ${statusColor}">
                                ${submission.status}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================
        // NOTIFICATIONS DISPLAY
        // ============================
        function displayNotifications() {
            const list = document.getElementById('notificationsList');
            if (!list) return;
            
            if (notifications.length === 0) {
                list.innerHTML = `
                    <div class="glass-card p-8 text-center">
                        <i class="fas fa-bell-slash text-4xl text-gray-400 mb-4"></i>
                        <h3 class="font-bold mb-2">No Notifications</h3>
                        <p class="text-gray-400">You're all caught up!</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = notifications.map(notif => {
                const icon = {
                    'info': 'fas fa-info-circle text-blue-400',
                    'success': 'fas fa-check-circle text-green-400',
                    'warning': 'fas fa-exclamation-triangle text-yellow-400',
                    'error': 'fas fa-times-circle text-red-400'
                }[notif.type] || 'fas fa-info-circle text-blue-400';
                
                return `
                    <div class="glass-card p-4 ${notif.is_read ? '' : 'border-l-4 border-blue-500'}">
                        <div class="flex items-start gap-3">
                            <i class="${icon} mt-1 text-lg"></i>
                            <div class="flex-1">
                                <h4 class="font-semibold mb-1">${notif.title}</h4>
                                <p class="text-sm text-gray-300">${notif.message}</p>
                                <div class="text-xs text-gray-400 mt-2">
                                    ${formatTimeAgo(notif.created_at)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function markAllAsRead() {
            try {
                const unreadIds = notifications
                    .filter(n => !n.is_read)
                    .map(n => n.id);
                
                if (unreadIds.length === 0) {
                    showToast('No unread notifications', 'info');
                    return;
                }
                
                const { error } = await supabase
                    .from('notifications')
                    .update({ is_read: true })
                    .in('id', unreadIds);
                
                if (error) throw error;
                
                // Update local state
                notifications.forEach(n => n.is_read = true);
                updateNotificationDot();
                
                displayNotifications();
                showToast('All notifications marked as read', 'success');
                
            } catch (error) {
                console.error('Error marking notifications as read:', error);
                showToast('Error updating notifications', 'error');
            }
        }

        function updateNotificationDot() {
            const unreadCount = notifications.filter(n => !n.is_read).length;
            const desktopDot = document.getElementById('notificationDot');
            const mobileDot = document.getElementById('mobileNotificationDot');
            
            if (unreadCount > 0) {
                desktopDot.classList.remove('hidden');
                mobileDot.classList.remove('hidden');
            } else {
                desktopDot.classList.add('hidden');
                mobileDot.classList.add('hidden');
            }
        }

        // ============================
        // SOS FUNCTION
        // ============================
        async function triggerSOS() {
            const confirmed = confirm(
                'ðŸš¨ EMERGENCY SOS\n\n' +
                'This will alert event organizers and emergency services.\n\n' +
                'Continue?'
            );
            
            if (!confirmed) return;
            
            try {
                await supabase
                    .from('sos_alerts')
                    .insert({
                        user_id: userProfile.id,
                        location: JSON.stringify({ lat: -22.5609, lng: 17.0832 }),
                        message: 'Emergency SOS activated by user',
                        status: 'active'
                    });
                
                // Create notification
                await supabase
                    .from('notifications')
                    .insert({
                        user_id: userProfile.id,
                        title: 'SOS Alert Sent',
                        message: 'Emergency services have been alerted. Help is on the way.',
                        type: 'warning'
                    });
                
                await loadNotifications();
                
                showToast('ðŸš¨ SOS Alert Sent! Help is on the way.', 'success');
                
                setTimeout(() => {
                    const call = confirm('Call Namibia Emergency: +264 81 111 1111?');
                    if (call) {
                        window.open('tel:+26481111111', '_blank');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error sending SOS:', error);
                showToast('Error sending SOS alert', 'error');
            }
        }

        // ============================
        // LOGOUT
        // ============================
        async function handleLogout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                userProfile = null;
                
                // Clear timer
                if (eventTimerInterval) {
                    clearInterval(eventTimerInterval);
                }
                
                // Reset to auth screen
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('signupForm').classList.add('hidden');
                
                // Clear forms
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('signupName').value = '';
                document.getElementById('signupEmail').value = '';
                document.getElementById('signupPassword').value = '';
                document.getElementById('signupTeam').value = '';
                
                showToast('Logged out successfully', 'info');
                
            } catch (error) {
                console.error('Error logging out:', error);
                showToast('Error logging out', 'error');
            }
        }

        // ============================
        // UTILITY FUNCTIONS
        // ============================
        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMin = Math.floor(diffMs / (1000 * 60));
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if (diffDay > 0) return `${diffDay}d ago`;
            if (diffHour > 0) return `${diffHour}h ago`;
            if (diffMin > 0) return `${diffMin}m ago`;
            return 'just now';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 fade-in`;
            toast.innerHTML = `
                <i class="${icons[type]}"></i>
                <span class="flex-1">${message}</span>
                <button type="button" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // ============================
        // MEDIA PREVIEW
        // ============================
        document.addEventListener('DOMContentLoaded', () => {
            const mediaInput = document.getElementById('mediaInput');
            if (mediaInput) {
                mediaInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const preview = document.getElementById('mediaPreview');
                    
                    if (!file) return;
                    
                    preview.innerHTML = '';
                    
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            preview.innerHTML = `
                                <div class="relative">
                                    <img src="${e.target.result}" alt="Preview" class="w-full h-48 object-cover rounded-lg">
                                    <span class="absolute top-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded">
                                        <i class="fas fa-image mr-1"></i>Image
                                    </span>
                                </div>
                            `;
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type.startsWith('video/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            preview.innerHTML = `
                                <div class="relative">
                                    <video src="${e.target.result}" controls class="w-full h-48 object-cover rounded-lg"></video>
                                    <span class="absolute top-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded">
                                        <i class="fas fa-video mr-1"></i>Video
                                    </span>
                                </div>
                            `;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
    </script>
</body>
</html>
